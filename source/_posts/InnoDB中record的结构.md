---
title: InnoDB中record的结构
abbrlink: 4a17b157
---

# InnoDB 中 record 的结构

## 前言

我们都知道，`MySQL`的服务端是通过操作`存储引擎`来读取和写入表中的数据。`MySQL`支持很多种不同的存储引擎，例如`InnoDB`、`MyISAM`、`Memory`之类的。不同的存储引擎是为了不同的目的实现的，**实际的数据在不同的引擎中存放的格式以及方式一般是不一样的**。而我们的`MySQL`中默认的存储引擎是 InnoDB，所以主要了解一下 InnoDB 中一条记录（record）究竟是如何存储的。

### InnoDB 中页的简介

我们要了解`record`在`InnoDB`中究竟是如何被组织的，那么不可避免要接触到的一个概念就是页。**页是`InnoDB`将数据在磁盘与内存中进行交换的基本单位**；同时，**我们的`record`也都是存储在页中**。一般来说页的大小是 16KB。

## 正文

我们使用数据库的时候，数据库中数据的层次结构可以大致理解成：数据库—表—记录。我们平时实际是以记录为单位来对表进行增删改查，记录在磁盘上存储的格式就叫做`行格式`或者`记录格式`。InnoDB 目前有四种不同的`行格式`：`Compact`、`Redundant`、`Dynamic`和`Compressed`。

### Compact 行格式

![COMPACT行格式](https://picture.dobyasa.com/20230104165511.png)

上图就是 Compact 行格式的示意图，一个 record 可以简单分为`真实数据`与`额外信息`两个部分。

**额外信息**

额外信息也就是 MySQL 为了描述这个记录而加上去的一些信息。信息主要有三类：`变长字段长度列表`、`NULL值列表`与`记录头信息`。

**变长字段长度列表**

众所周知，`MySQL`支持很多变长的数据类型，比如我们很常用的`VARCHAR(M)`、`TEXT`等等。这种字段的长度是不固定的，所以我们在记录他们的真实数据的同时也**需要记录他们所占用的字节数**。

在 Compact 行格式中，InnoDB 会把所有变长字段的真实数据占用的字节长度都存放在记录的开头，并且**变长字段字节长度列表中的的顺序与实际列的顺序是相反的**，也就是以列顺序的逆序存放的。

**BULL 值列表**

这个听名字我们应该都能知道是什么意思。有的`record`中，可能某一列的内容是`NULL`，这样的话我们就不会去将 NULL 存储在`真实数据`中。

**记录头信息**

`记录头信息`就是用来描述`record`的一些信息。总共有五个字节，也就是 40 个比特。

| **名称**       | **大小（单位：bit）** | **描述**                                                                                          |
| -------------- | --------------------- | ------------------------------------------------------------------------------------------------- |
| `预留位1`      | `1`                   | 没有使用                                                                                          |
| `预留位2`      | `1`                   | 没有使用                                                                                          |
| `delete_mask`  | `1`                   | 标记该记录是否被删除                                                                              |
| `min_rec_mask` | `1`                   | B+树的每层非叶子节点中的最小记录都会添加该标记                                                    |
| `n_owned`      | `4`                   | 表示当前记录拥有的记录数                                                                          |
| `heap_no`      | `13`                  | 表示当前记录在记录堆的位置信息                                                                    |
| `record_type`  | `3`                   | 表示当前记录的类型，`0`表示普通记录，`1`表示 B+树非叶子节点记录，`2`表示最小记录，`3`表示最大记录 |
| `next_record`  | `16`                  | 表示下一条记录的相对位置                                                                          |

具体的各个比特的作用暂时还不用太详细了解，只是知道他们是描述一条 record 所需的信息就行了。

**真实数据**

**隐藏列**

其实上面的图中所展示的真实数据的格式并不准确，因为`MySQL`在每条`record`中，除了用户定义的列之外，还会有三个**隐藏列**：`row_id`、`transaction_id`、`roll_pointer`。

| **列名**         | **是否必须** | **占用空间** | **描述**                |
| ---------------- | ------------ | ------------ | ----------------------- |
| `row_id`         | 否           | `6`字节      | 行 ID，唯一标识一条记录 |
| `transaction_id` | 是           | `6`字节      | 事务 ID                 |
| `roll_pointer`   | 是           | `7`字节      | 回滚指针                |

上面三个隐藏列中只有`row_id`不是必须的，这个隐藏列**只有在用户没有定义主键并且没有`unique`列的时候才会被`MySQL`自动定义**。

### Redundant 行格式

`Redundant`行格式是`MySQL5.0`之前使用的一种行格式，下面只是简单介绍一下，不用太深入了解。

![img](https://picture.dobyasa.com/20230104165708.png)

**字段长度偏移列表**

`Redundant`的`字段长度偏移列表`与`Compact`的`变长字段长度列表`不同的就是，它会存储**所有列**的**偏移**，而不是边长列的字节长度。获取某一列的长度时，是根据两个相邻偏移的差值来计算出来的。

**记录头信息**

与`Compact`中的`记录头信息`相似，记录的是 record 的一些额外信息。
